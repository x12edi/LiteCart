@model List<ECommerce.Web.Models.OrderViewModel>
@{
    ViewData["Title"] = "Manage Orders";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <partial name="_SidebarPartial" />
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <h2>@ViewData["Title"]</h2>
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">@TempData["SuccessMessage"]</div>
        }
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>User Email</th>
                    <th>Total Amount</th>
                    <th>Status</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var order in Model)
                {
                    <tr>
                        <td>@order.Id</td>
                        <td>@order.UserEmail</td>
                        <td>@order.TotalAmount.ToString("C")</td>
                        <td>@order.Status</td>
                        <td>@order.CreatedAt.ToString("g")</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="loadEditForm(@order.Id)">Edit</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </main>
</div>

<!-- Modal for Edit -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderModalLabel">Edit Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="orderFormContainer">
                <!-- Form will be loaded via AJAX -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function loadEditForm(id) {
            $.get('/Order/Edit/' + id, function (data) {
                $('#orderFormContainer').html(data);
                $('#orderModalLabel').text('Edit Order');
                $('#orderModal').modal('show');
                $.validator.unobtrusive.parse('#orderForm');
            });
        }

        $(document).ready(function () {
            $('#orderFormContainer').on('submit', '#orderForm', function (e) {
                e.preventDefault();
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: $(this).serialize(),
                    headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
                    success: function (result) {
                        if (result.success) {
                            $('#orderModal').modal('hide');
                            location.reload();
                        } else {
                            $('#orderFormContainer').html(result);
                            $.validator.unobtrusive.parse('#orderForm');
                        }
                    },
                    error: function () {
                        alert('Error saving order.');
                    }
                });
            });
        });
    </script>
}