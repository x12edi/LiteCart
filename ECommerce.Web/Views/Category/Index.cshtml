@model IEnumerable<ECommerce.Web.Models.CategoryViewModel>

@{
    ViewData["Title"] = "Manage categorys";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="row">
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <h2>@ViewData["Title"]</h2>
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">@TempData["SuccessMessage"]</div>
        }
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#categoryModal" onclick="loadCreateForm()">Add Category</button>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Category ID</th>
                    <th>Name</th>
                    <th>Parent Category</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var o in Model)
                {
                    <tr>
                        <td>@o.Id</td>
                        <td>@o.Name</td>
                        <td>@o.ParentCategory</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="loadEditForm(@o.Id)">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(@o.Id)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </main>
</div>
<!-- Modal for Edit -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalLabel">Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="categoryFormContainer">
                <!-- Form will be loaded via AJAX -->
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <partial name="_ValidationScriptsPartial" />
    <script>
        function loadCreateForm()
        {
            $.get('/Category/Create/' , function (data) {
                $('#categoryFormContainer').html(data);
                $('#categoryModalLabel').text('Add Category');
                $('#categoryModal').modal('show');
                $.validator.unobtrusive.parse('#categoryForm');
            });
        }

        function loadEditForm(id)
        {
            $.get('/Category/Edit/' + id, function (data) {
                $('#categoryFormContainer').html(data);
                $('#categoryModalLabel').text('Edit Category');
                $('#categoryModal').modal('show');
                $.validator.unobtrusive.parse('#categoryForm');
            });
        }

        function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this category?')) {
                $.ajax({
                    url: '/Category/Delete/' + id,
                    type: 'POST',
                    //data: { id: id },
                    /*headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },*/
                    success: function (result) {
                        if (result.success) {
                            location.reload();
                        } else {
                            alert(result.message);
                        }
                    },
                    error: function (xhr) {
                        console.log(xhr.responseText);
                        alert('Error ' + xhr.status + ': ' + xhr.statusText);
                    }
                });
            }
        }

        $(document).ready(function () {
            $('#categoryFormContainer').on('submit', '#categoryForm', function (e) {
                e.preventDefault();
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: $(this).serialize(),
                    headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
                    success: function (result) {
                        if (result.success) {
                            $('#categoryModal').modal('hide');
                            location.reload();
                        } else {
                            $('#categoryFormContainer').html(result);
                            $.validator.unobtrusive.parse('#categoryForm');
                        }
                    },
                    error: function () {
                        alert('Error saving category.');
                    }
                });
            });
        });

    </script>
}
